# http://www.appveyor.com/docs/appveyor-yml

#---------------------------------#
#    environment configuration    #
#---------------------------------#

# Operating system (build VM template)
os: Visual Studio 2015

# Skipping commits with particular message
skip_commits:
  message: /\[ci skip\]/

# environment variables
environment:
  matrix:
  - nodejs_version: 8
  - nodejs_version: 10
  - nodejs_version: 11
  - nodejs_version: 12

# scripts that run after cloning repository
install:
  - ps: Install-Product node $env:nodejs_version
  - git submodule update --init --recursive

#---------------------------------#
#       build configuration       #
#---------------------------------#

build_script:
  - cmd: npm install

## Build Artifacts

artifacts:
  - path: 'build/stage/**/argon2*.tar.gz'

#---------------------------------#
#       tests configuration       #
#---------------------------------#

# scripts to run before tests
before_test:
  - node --version
  - npm --version

# to run your custom scripts instead of automatic tests
test_script:
  - npm test

# publish to Github
after_test:
    - .\node_modules\.bin\node-pre-gyp package

on_success:
  - ps: >
        if ($env:NODE_PRE_GYP_GITHUB_TOKEN -ne $null -and $env:APPVEYOR_REPO_TAG_NAME -match '^v(0|[1-9]+)\.(0|[1-9]+)\.(0|[1-9]+)$') {
            echo "Publishing $env:APPVEYOR_REPO_TAG_NAME"
            npm install node-pre-gyp-github
            ./node_modules/.bin/node-pre-gyp-github publish --release
        }